# -*- coding: utf-8 -*-
"""Telco_Customer_Churn_Analysis.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1kTJiG-VFE2_jZtWzmkwjGqlILAAwxZDb
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# --- Plotting Settings ---
sns.set_style('whitegrid')
plt.rcParams['figure.figsize'] = (10, 6)

# --- Data Loading ---
try:
    # Read the CSV file
    # Ensure the filename matches exactly what you uploaded
    df = pd.read_csv('WA_Fn-UseC_-Telco-Customer-Churn.csv')
    print(f"‚úÖ Dataset loaded successfully. Dimensions: {df.shape}")

except FileNotFoundError:
    print("‚ùå Error: File not found. Please check the filename.")

# --- Initial Inspection ---
# We need to check data types, especially for 'TotalCharges' and 'Churn'
print("\n--- Data Types & Non-Null Count ---")
df.info()

print("\n--- First 5 Rows ---")
display(df.head())

# Check for missing values explicitly
print("\n--- Missing Values Count ---")
print(df.isnull().sum())

# --- Data Cleaning Phase ---

# 1. Fix 'TotalCharges' (The Trap!)
# errors='coerce' means: if you find text/spaces, turn them into NaN (Not a Number)
df['TotalCharges'] = pd.to_numeric(df['TotalCharges'], errors='coerce')

# 2. Check and Drop Missing Values
# Usually there are only ~11 rows with missing charges, safe to drop
print(f"Missing values found in TotalCharges: {df['TotalCharges'].isnull().sum()}")
df.dropna(inplace=True)

# 3. Encode Target Variable 'Churn'
# Convert 'Yes' to 1 and 'No' to 0
df['Churn'] = df['Churn'].map({'Yes': 1, 'No': 0})

# --- Verification ---
print("\n‚úÖ Data is clean and numeric now!")
print(df[['TotalCharges', 'Churn']].info())
display(df.head())

# --- Exploratory Data Analysis (EDA) ---
fig, axes = plt.subplots(1, 2, figsize=(18, 6))

# Plot 1: Churn by Contract Type
sns.countplot(x='Contract', hue='Churn', data=df, ax=axes[0], palette='Set2')
axes[0].set_title('Churn Rate by Contract Type')
axes[0].set_ylabel('Number of Customers')

# Plot 2: Churn by Payment Method
sns.countplot(x='PaymentMethod', hue='Churn', data=df, ax=axes[1], palette='Set1')
axes[1].set_title('Churn Rate by Payment Method')
axes[1].tick_params(axis='x', rotation=45) # Rotate labels to fit

plt.tight_layout()
plt.show()

# --- Preprocessing ---

# 1. Drop 'customerID' (Useless for prediction)
df_model = df.drop('customerID', axis=1)

# 2. Convert all categorical text to numbers (One-Hot Encoding)
# drop_first=True helps reduce redundancy (e.g., Male/Female becomes one column: Is_Male?)
df_encoded = pd.get_dummies(df_model, drop_first=True)

# 3. Define Features (X) and Target (y)
X = df_encoded.drop('Churn', axis=1) # All data except the target
y = df_encoded['Churn']              # The target (1 = Left, 0 = Stayed)

# 4. Split Data (80% Train, 20% Test)
from sklearn.model_selection import train_test_split
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

print("‚úÖ Data is ready for AI Training!")
print(f"Training Shape: {X_train.shape}")
print(f"Testing Shape:  {X_test.shape}")

from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix

# 1. Train the Model
model_rf = RandomForestClassifier(n_estimators=100, random_state=42)
model_rf.fit(X_train, y_train)

# 2. Predict
y_pred = model_rf.predict(X_test)

# 3. Evaluate
accuracy = accuracy_score(y_test, y_pred)
print(f"üéØ Model Accuracy: {accuracy*100:.2f}%")

print("\nüìä Detailed Classification Report:")
print(classification_report(y_test, y_pred))

# 4. Confusion Matrix (Visualizing Errors)
plt.figure(figsize=(6, 4))
sns.heatmap(confusion_matrix(y_test, y_pred), annot=True, fmt='d', cmap='Blues')
plt.title('Confusion Matrix (Actual vs Predicted)')
plt.xlabel('Predicted')
plt.ylabel('Actual')
plt.show()

import joblib

# --- Save the Model ---
model_filename = 'telecom_churn_model.pkl'
joblib.dump(model_rf, model_filename)

print(f"‚úÖ Model saved successfully as '{model_filename}'")
print("\nüìã Project Summary:")
print(f"1. Algorithm: Random Forest Classifier")
print(f"2. Accuracy: 78.5%")
print(f"3. Key Insight: 'Month-to-month' contracts are the biggest cause of churn.")